<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout/_LayoutUser :: layout(
          'Chi ti·∫øt s·∫£n ph·∫©m',
          ~{::content},
          ~{}
      )}">

<th:block th:fragment="content">
    <style>
        .product-detail-container { background: #fff; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .img-detail-wrapper { background-color: #fdfdfd; display: flex; align-items: center; justify-content: center; padding: 20px; border-radius: 12px; }
        .img-detail { max-height: 400px; object-fit: contain; transition: transform 0.3s ease; }
        .product-name { font-weight: 800; color: #2d3436; font-size: 1.8rem; margin-bottom: 15px; }
        .product-price-large { font-size: 2rem; color: #d63031; font-weight: 800; margin-bottom: 20px; display: block; }
        .review-card { background: #fcfcfc; border-left: 4px solid #f4a100; margin-bottom: 15px; padding: 15px; }
        .star-rating { color: #f4a100; font-weight: bold; }
        .review-form-box { background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 30px; }
        .btn-buy-now { background-color: #f4a100; border: none; padding: 12px 30px; font-weight: 700; border-radius: 8px; color: white; }
    </style>

    <div class="mb-4">
        <a th:href="@{/sanpham}" class="text-muted text-decoration-none small">‚Üê Quay l·∫°i danh s√°ch s·∫£n ph·∫©m</a>
    </div>

    <div th:if="${message}" class="alert alert-success alert-dismissible fade show shadow-sm mb-4">
        <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show shadow-sm mb-4">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${sp != null}" class="product-detail-container p-4">
        <div class="row">
            <div class="col-md-5">
                <div class="img-detail-wrapper border">
                    <img th:src="${sp.hinhAnh != null && sp.hinhAnh != ''} ? @{/uploads/{img}(img=${sp.hinhAnh})} : @{/images/no-image.png}" class="img-fluid img-detail">
                </div>
            </div>
            <div class="col-md-7">
                <div class="product-info-box p-2">
                    <h2 class="product-name" th:text="${sp.ten}"></h2>

                    <div class="mb-3" th:if="${avgStar != null}">
                        <span class="star-rating">‚≠ê <span th:text="${#numbers.formatDecimal(avgStar, 1, 1)}"></span> / 5.0</span>
                    </div>

                    <span class="product-price-large" th:text="${#numbers.formatDecimal(sp.gia,0,'POINT',0,'COMMA')} + ' ƒë'"></span>

                    <div class="meta-data mb-4">
                        <div class="small mb-2"><strong>Danh m·ª•c:</strong> <span th:text="${sp.danhMuc != null ? sp.danhMuc.ten : 'N/A'}"></span></div>
                        <div class="small mb-2"><strong>Th∆∞∆°ng hi·ªáu:</strong> <span th:text="${sp.thuongHieu != null ? sp.thuongHieu.ten : 'N/A'}"></span></div>
                        <p class="text-secondary mt-3 small" th:text="${sp.moTa}"></p>
                    </div>

                    <div sec:authorize="isAuthenticated()">
                        <form th:action="@{/giohang/add}" method="post">
                            <input type="hidden" name="productId" th:value="${sp.id}" />
                            <input type="hidden" name="quantity" value="1" />
                            <button type="submit" class="btn btn-buy-now">üõí TH√äM V√ÄO GI·ªé H√ÄNG</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-5">
        <h4 class="fw-bold mb-4">ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h4>

        <div th:if="${#lists.isEmpty(listDanhGia)}" class="text-center py-4">
            <p class="text-muted small">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>
        </div>

        <div th:each="dg : ${listDanhGia}" class="review-card shadow-sm">
            <div class="d-flex justify-content-between">
                <div>
                    <strong th:text="${dg.nguoiDung?.hoTen ?: 'Ng∆∞·ªùi d√πng'}"></strong>
                    <span class="star-rating ms-2">
                        <span th:if="${dg.soSao > 0}" th:each="i : ${#numbers.sequence(1, dg.soSao)}">‚≠ê</span>
                    </span>
                </div>
                <small class="text-muted" th:text="${#temporals.format(dg.thoiGian,'dd/MM/yyyy')}"></small>
            </div>
            <p class="mt-2 mb-0 small text-secondary" th:text="${dg.binhLuan}"></p>
        </div>

        <div sec:authorize="isAuthenticated()" class="review-form-box shadow-sm">
            <h5 class="fw-bold mb-3 small">G·ª≠i nh·∫≠n x√©t c·ªßa b·∫°n</h5>
            <form th:action="@{/sanpham/danhgia/{id}(id=${sp.id})}" method="post" th:object="${newDanhGia}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label small fw-bold">M·ª©c ƒë·ªô h√†i l√≤ng</label>
                        <select class="form-select shadow-sm border-0" th:field="*{soSao}" required>
                            <option value="5">5 ‚≠ê (Tuy·ªát v·ªùi)</option>
                            <option value="4">4 ‚≠ê (T·ªët)</option>
                            <option value="3">3 ‚≠ê (B√¨nh th∆∞·ªùng)</option>
                            <option value="2">2 ‚≠ê (K√©m)</option>
                            <option value="1">1 ‚≠ê (R·∫•t t·ªá)</option>
                        </select>
                    </div>
                    <div class="col-12 mb-3">
                        <textarea class="form-control shadow-sm border-0" th:field="*{binhLuan}" rows="3" placeholder="N·ªôi dung ƒë√°nh gi√°..." required></textarea>
                    </div>
                </div>
                <button type="submit" class="btn btn-dark fw-bold px-4">G·ª≠i ƒë√°nh gi√°</button>
            </form>
        </div>

        <div sec:authorize="!isAuthenticated()" class="mt-4 text-center p-3 bg-light rounded">
            <small>Vui l√≤ng <a th:href="@{/auth/login}" class="fw-bold">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ ƒë√°nh gi√° s·∫£n ph·∫©m.</small>
        </div>
    </div>
</th:block>
</html>